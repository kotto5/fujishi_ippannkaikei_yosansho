# 次のAgentへの引き継ぎ指示

## タスク概要
富士市の一般会計予算書をデータ化するプロジェクトです。
背景として、富士市の一般会計予算書はPDFで配布されており、データ分析がしづらい状態になっています。そのため、まずはデータを分析可能な形に変換することを目的としています。

## 具体的なステップ：
1. PDFからのデータをJSONに変換します。
   - **推奨**: pdfplumber + Y座標マッチングによる座標ベース抽出（詳細は「作業手順」セクション参照）
   - OCRベースは見開きページの左右紐付けが失われるため非推奨

2. json_to_csv.pyを使用して、JSONのデータをCSVに変換します。
3. 開発者がCSVのデータをスプレッドシートにインポートすることで、分析を可能にします。

## ファイル構成

./ (root)
README.md: このファイル. タスク実行者が読むべきドキュメント
json_to_csv.py: PDFのデータをJSON化したものを、CSVにコンバートするプログラム
sample_歳入.json: 歳入の 特に 市税(款)のJSONのサンプル（期待する構造の参考）

./n年度予算/
- bugget.pdf：予算の元データ
- bugget.json：予算をJSON化したもの
- bugget.csv：json_to_csv.py でJSONをCSV化したもの
- extract_budget_v*.py：座標ベースPDF抽出スクリプト（推奨）
- validate_json.py：JSONスキーマバリデーション
- JSON_SPEC.md：期待するJSON構造の仕様書
- 学び.md：その年度の作業で得た知見

## 注意点
1. bugget.pdf データは 70MB 前後です。座標ベース抽出（pdfplumber）を使用する場合、ページ単位で処理するためトークン制限の心配は不要です。

2. CSVのデータを編集してはなりません。あくまで編集するのはJSONデータであり、CSVの生成はPythonのプログラムを通して行います。

3. pdf データにある、数値データのうち 計算式が入るものに関しては、テキストとして扱いましょう。
   - 例: 測定見込額 408,000×98.9％ → `"測定見込額": "408000*98.9%"`
   - 演算子をプログラミングの一般的なものに（×→*、÷→/）
   - カンマ (,) は削除する
   - 単位 (%) は 半角の % を利用する

4. 節と説明の最初の行でデータが重複している場合は、説明の行を削除しましょう。データの構造化によって情報量を失わず、より扱いやすいデータ構造にします。

5. 金額が (千円) などと示されているところは、入力する数値を1000倍する必要があります。

ex:
元データ
"""
15,717,0001 現年課税分 現年課税分 15,717,000
均等割 403,000
調定見込額 408,000×98.9％
所得割 15,314,000
調定見込額 （15,490,000-5,000）×98.9％
"""

期待するjson
```json
{
  "現年課税分": {
    "金額": 15717000000,
    "説明": {
      "均等制": {
        "金額": 403000000,
        "測定見込額": "408000*98.9%"
      },
      "所得割": {
        "金額": 15314000000,
        "測定見込額": "(15490000-5000)*98.9%"
      }
    }
  }
}
```

## CSV出力フォーマット
```
款,項,目,節,説明,R6,R7
議会費,,,,,481596,499446
,議会費,,,,481596,499446
,,議会費,,,481596,499446
,,,報酬,,,205923
,,,,議長等議員報酬,,205923
```
- UTF-8（BOMなし）、LF改行
- 金額は千円単位、カンマ区切りなし

## データソース
富士市のサイト: https://www.city.fuji.shizuoka.jp/documents/7863/hngtkl000000jj0q_1.pdf
（600ページ超の完全版予算書。歳出事項別明細書は中盤〜後半に収録）

**重要**: スキャンPDFではなく、テキスト埋め込みPDFを使うこと。上記URLの原本はテキスト型。

## 作業手順

### 推奨アプローチ: 座標ベース抽出（pdfplumber）

**OCRベースではなく、座標ベースの抽出を推奨します。**

予算書PDFは見開き2ページで1セット:
- 左ページ: 款・項・目の階層構造
- 右ページ: 節・説明・金額の詳細

OCRは「左ページ全部 → 右ページ全部」と読むため、Y軸の紐付けが失われます。

#### 座標ベース抽出の手順

```python
import pdfplumber

# 見開き2ページを結合
left_words = left_page.extract_words()
right_words = right_page.extract_words()

# 右ページのX座標をオフセット
for w in right_words:
    w['x0'] += page_width

# Y座標でグループ化（12px単位）
y_groups = defaultdict(list)
for w in all_words:
    y = round(w['top'] / 12) * 12
    y_groups[y].append(w)
```

参考実装: `6年度予算/extract_budget_v4.py`

### 作業の原則

1. **スキーマを先に定義する**
   - 期待するJSON構造を`JSON_SPEC.md`として文書化
   - サンプル: `sample_歳入.json`

2. **バリデーションテストを先に書く**
   - `validate_json.py`でスキーマ検証
   - 生成されたJSONがテストをパスするまで再生成

3. **後から吸収しようとしない**
   - 複数フォーマットを後から変換するのは複雑化の原因
   - 生成時に正しい形式を強制する

4. **見開きページは座標ベースで処理する**
   - pdfplumber + Y座標マッチング
   - Y tolerance は 12px が適切（PDF依存）

### 具体的なステップ

1. ページ範囲を特定（歳入・歳出それぞれ）
2. `extract_budget_v4.py`を参考に座標ベース抽出
3. `validate_json.py`でバリデーション
4. `json_to_csv.py`でCSV変換
5. 合計値の検証

## よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| 節の説明が欠落 | OCRが左右ページを別々に読む | 座標ベース抽出に切り替え |
| JSONフォーマットがバラバラ | 並列生成時の仕様不統一 | スキーマ定義→バリデーション→再生成 |
| 款ヘッダーが分割される | Y tolerance が小さすぎる | 5px → 12px に調整 |
| 一部の款が欠落 | ページ範囲が不正確 | PDFを確認してページ範囲を調整 |

## 学びの記録

各年度の作業で得た知見は `n年度予算/学び.md` に記録してください。
これにより、同じ問題で繰り返し困ることを防ぎます。
